<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>T·∫°o CV (AI) - CVBuilder</title>
    <link rel="stylesheet" th:href="@{/css/livecareer.css}">
</head>
<body>
<nav class="nav">
    <div class="brand">CVBuilder ‚ú®</div>
    <div class="links">
        <a href="/my-cvs">My CVs</a>
        <a href="/create-cv-ai">Create CV (AI)</a>
        <a href="/login" onclick="localStorage.removeItem('token')">Logout</a>
    </div>
</nav>

<div class="shell">
    <div class="card">
        <div class="stepper" id="steps">
            <div class="step active" data-step="1">1. Th√¥ng tin</div>
            <div class="step" data-step="2">2. Kinh nghi·ªám</div>
            <div class="step" data-step="3">3. H·ªçc v·∫•n</div>
            <div class="step" data-step="4">4. K·ªπ nƒÉng</div>
            <div class="step" data-step="5">5. T√≥m t·∫Øt/M·ª•c ti√™u</div>
            <div class="step" data-step="6">6. Preview/L∆∞u</div>
        </div>

        <form id="cv-form">
            <div class="two-col">
                <div>
                    <!-- STEP 1 -->
                    <section class="section" data-step="1" style="display:block;">
                        <div class="grid-2">
                            <div class="row"><label class="label">H·ªç t√™n</label><input class="input" name="fullName" required></div>
                            <div class="row"><label class="label">V·ªã tr√≠ ·ª©ng tuy·ªÉn</label><input class="input" name="jobTitle"></div>
                            <div class="row"><label class="label">Email</label><input class="input" type="email" name="email" required></div>
                            <div class="row"><label class="label">S·ªë ƒëi·ªán tho·∫°i</label><input class="input" name="phone"></div>
                            <div class="row"><label class="label">ƒê·ªãa ch·ªâ</label><input class="input" name="address"></div>
                            <div class="row"><label class="label">Ng√†y sinh</label><input class="input" type="date" name="dateOfBirth"></div>
                            <div class="row"><label class="label">LinkedIn</label><input class="input" name="linkedIn"></div>
                            <div class="row"><label class="label">Github</label><input class="input" name="github"></div>
                            <div class="row"><label class="label">Website</label><input class="input" name="websiteUrl"></div>
                        </div>
                        <div class="hr"></div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn pri" data-next>Ti·∫øp t·ª•c</button>
                        </div>
                    </section>

                    <!-- STEP 2 -->
                    <section class="section" data-step="2" style="display:none;">
                        <div class="row"><label class="label">Kinh nghi·ªám</label>
                            <textarea class="" name="experience" rows="6" placeholder="- C√¥ng ty A (2022‚Äìnay): ..."></textarea>
                            <div class="ai-bar">
                                <button type="button" class="btn gho" data-ai="experience">ü§ñ Ask AI m√¥ t·∫£ kinh nghi·ªám</button>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn gho" data-prev>Quay l·∫°i</button>
                            <button type="button" class="btn pri" data-next>Ti·∫øp t·ª•c</button>
                        </div>
                    </section>

                    <!-- STEP 3 -->
                    <section class="section" data-step="3" style="display:none;">
                        <div class="row"><label class="label">H·ªçc v·∫•n</label>
                            <textarea name="education" rows="5" placeholder="- ƒêH XYZ, CNTT (2018‚Äì2022): ..."></textarea>
                            <div class="ai-bar">
                                <button type="button" class="btn gho" data-ai="education">ü§ñ Ask AI m√¥ t·∫£ h·ªçc v·∫•n</button>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn gho" data-prev>Quay l·∫°i</button>
                            <button type="button" class="btn pri" data-next>Ti·∫øp t·ª•c</button>
                        </div>
                    </section>

                    <!-- STEP 4 -->
                    <section class="section" data-step="4" style="display:none;">
                        <div class="grid-2">
                            <div class="row"><label class="label">K·ªπ nƒÉng</label>
                                <textarea name="skills" rows="5" placeholder="Java, Spring Boot, REST, MySQL, Docker..."></textarea>
                                <div class="ai-bar">
                                    <button type="button" class="btn gho" data-ai="skills">ü§ñ Ask AI g·ª£i √Ω k·ªπ nƒÉng</button>
                                </div>
                            </div>
                            <div class="row"><label class="label">Ch·ª©ng ch·ªâ</label>
                                <textarea name="certifications" rows="5" placeholder="Oracle Java, AWS Cloud..."></textarea>
                                <div class="ai-bar">
                                    <button type="button" class="btn gho" data-ai="certifications">ü§ñ Ask AI g·ª£i √Ω ch·ª©ng ch·ªâ</button>
                                </div>
                            </div>
                        </div>
                        <div class="row"><label class="label">D·ª± √°n</label>
                            <textarea name="projects" rows="5" placeholder="- CVBuilder: Spring Boot + MySQL + JWT + Thymeleaf + OpenPDF..."></textarea>
                            <div class="ai-bar">
                                <button type="button" class="btn gho" data-ai="projects">ü§ñ Ask AI m√¥ t·∫£ d·ª± √°n</button>
                            </div>
                        </div>
                        <div class="row"><label class="label">Ng√¥n ng·ªØ</label>
                            <input class="input" name="languages" placeholder="Ti·∫øng Vi·ªát (Native), Ti·∫øng Anh (IELTS 7.0)">
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn gho" data-prev>Quay l·∫°i</button>
                            <button type="button" class="btn pri" data-next>Ti·∫øp t·ª•c</button>
                        </div>
                    </section>

                    <!-- STEP 5 -->
                    <section class="section" data-step="5" style="display:none;">
                        <div class="row"><label class="label">T√≥m t·∫Øt h·ªì s∆° (Profile Summary)</label>
                            <textarea name="profileSummary" rows="5" placeholder="3‚Äì5 d√≤ng n·ªïi b·∫≠t..."></textarea>
                            <div class="ai-bar">
                                <button type="button" class="btn gho" data-ai="summary">ü§ñ Ask AI vi·∫øt t√≥m t·∫Øt</button>
                            </div>
                        </div>
                        <div class="row"><label class="label">M·ª•c ti√™u ngh·ªÅ nghi·ªáp (Career Objective)</label>
                            <textarea name="careerObjective" rows="4" placeholder="1‚Äì2 c√¢u ng·∫Øn g·ªçn..."></textarea>
                            <div class="ai-bar">
                                <button type="button" class="btn gho" data-ai="objective">ü§ñ Ask AI vi·∫øt m·ª•c ti√™u</button>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn gho" data-prev>Quay l·∫°i</button>
                            <button type="button" class="btn pri" data-next>Ti·∫øp t·ª•c</button>
                        </div>
                    </section>

                    <!-- STEP 6 -->
                    <section class="section" data-step="6" style="display:none;">
                        <div style="display:flex;gap:8px;justify-content:flex-start; margin-bottom:8px;">
                            <button type="button" class="btn gho" id="refresh-preview">üîÑ C·∫≠p nh·∫≠t Preview</button>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button type="button" class="btn gho" data-prev>Quay l·∫°i</button>
                            <button type="submit" class="btn ok">üíæ L∆∞u CV</button>
                        </div>
                    </section>
                </div>

                <!-- Preview -->
                <aside class="preview">
                    <div class="muted">üìÑ Xem tr∆∞·ªõc CV</div>
                    <div class="paper" id="preview">
                        <h2 id="p_fullName">H·ªç t√™n</h2>
                        <div class="muted">
                            <span id="p_jobTitle">V·ªã tr√≠</span> ‚Ä¢
                            <span id="p_email">email@example.com</span> ‚Ä¢
                            <span id="p_phone">0123</span> ‚Ä¢
                            <span id="p_address">ƒê·ªãa ch·ªâ</span>
                        </div>
                        <div class="hr"></div>
                        <h3>T√≥m t·∫Øt</h3>
                        <div id="p_profileSummary">‚Äî</div>
                        <h3>M·ª•c ti√™u</h3>
                        <div id="p_careerObjective">‚Äî</div>
                        <h3>Kinh nghi·ªám</h3>
                        <div id="p_experience">‚Äî</div>
                        <h3>H·ªçc v·∫•n</h3>
                        <div id="p_education">‚Äî</div>
                        <h3>K·ªπ nƒÉng</h3>
                        <div id="p_skills">‚Äî</div>
                        <h3>Ch·ª©ng ch·ªâ</h3>
                        <div id="p_certifications">‚Äî</div>
                        <h3>D·ª± √°n</h3>
                        <div id="p_projects">‚Äî</div>
                        <h3>Ng√¥n ng·ªØ</h3>
                        <div id="p_languages">‚Äî</div>
                        <h3>Li√™n k·∫øt</h3>
                        <div id="p_links">LinkedIn ‚Ä¢ Github ‚Ä¢ Website</div>
                    </div>
                </aside>
            </div>
        </form>
    </div>
</div>

<script>
    // Auth gate
    const token = localStorage.getItem('token');
    if (!token) { alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!'); window.location.href = '/login'; }

    // Wizard control
    const steps = [...document.querySelectorAll('.step')];
    const sections = [...document.querySelectorAll('.section')];
    let current = 1;
    const showStep = (n) => {
        current = n;
        steps.forEach(s => s.classList.toggle('active', +s.dataset.step === n));
        sections.forEach(s => s.style.display = (+s.dataset.step === n ? 'block' : 'none'));
    };
    steps.forEach(s => s.addEventListener('click', () => showStep(+s.dataset.step)));
    document.querySelectorAll('[data-next]').forEach(b => b.addEventListener('click', () => showStep(current+1)));
    document.querySelectorAll('[data-prev]').forEach(b => b.addEventListener('click', () => showStep(current-1)));

    // Preview sync
    const mapIds = {
        fullName:'p_fullName', jobTitle:'p_jobTitle', email:'p_email', phone:'p_phone', address:'p_address',
        profileSummary:'p_profileSummary', careerObjective:'p_careerObjective', experience:'p_experience',
        education:'p_education', skills:'p_skills', certifications:'p_certifications', projects:'p_projects',
        languages:'p_languages'
    };
    const allInputs = document.querySelectorAll('input, textarea');
    function syncPreview() {
        allInputs.forEach(el => {
            const id = mapIds[el.name];
            if (id) document.getElementById(id).textContent = el.value || '‚Äî';
        });
        const li = document.querySelector('input[name="linkedIn"]').value || '';
        const gh = document.querySelector('input[name="github"]').value || '';
        const wb = document.querySelector('input[name="websiteUrl"]').value || '';
        document.getElementById('p_links').textContent = [li && 'LinkedIn', gh && 'Github', wb && 'Website'].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
    }
    allInputs.forEach(el => el.addEventListener('input', syncPreview));
    document.getElementById('refresh-preview').addEventListener('click', syncPreview);

    // AI Suggest
    async function askAI(section) {
        const jobTitle = document.querySelector('[name="jobTitle"]').value || '';
        const fullName = document.querySelector('[name="fullName"]').value || '';
        const targetName = section === 'summary' ? 'profileSummary' : (section === 'objective' ? 'careerObjective' : section);
        const currentText = document.querySelector(`[name="${targetName}"]`)?.value || '';

        const res = await fetch('/api/ai/suggest', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + token },
            body: JSON.stringify({ section, jobTitle, fullName, currentText })
        });
        if (!res.ok) { alert('AI g·ª£i √Ω l·ªói'); return; }
        const data = await res.json();
        const target = document.querySelector(`[name="${targetName}"]`);
        target.value = (target.value ? target.value + '\n' : '') + data.suggestion;
        target.dispatchEvent(new Event('input'));
    }
    document.querySelectorAll('[data-ai]').forEach(btn => btn.addEventListener('click', () => askAI(btn.getAttribute('data-ai'))));

    // Save CV
    document.getElementById('cv-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const json = Object.fromEntries(formData.entries());

        const res = await fetch('/api/cv', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Accept':'application/json', 'Authorization':'Bearer ' + token },
            body: JSON.stringify(json)
        });
        if (res.ok) {
            alert('ƒê√£ l∆∞u CV th√†nh c√¥ng!');
            window.location.href = '/my-cvs';
        } else {
            const err = await res.text();
            alert('L·ªói l∆∞u CV: ' + err);
        }
    });
</script>
</body>
</html>
